%% Generate_Results_Lib5_L1O_reduced_model
% SynTwin workflow script: post-processing and compilation of Lib5 (L1O)
% reduced-model results.
%
% CONTEXT (Lib5 sublibrary)
%   Lib5 is a 5-TU sublibrary defined by:
%     - 1 plasmid origin  (pGreen; Ori index fixed to 1)
%     - 1 promoter        (J23100; promoter index fixed in Lib5 tensor)
%     - 5 RBS variants    (RBS indices: [1 2 3 4 5])
%
%   In this workflow:
%     - The promoter strength Omega (J23100) is estimated under L1O
%       cross-validation (leave one RBS-defined TU out at a time).
%     - RBS intrinsic initiation capacity k0_sigma0 is NOT re-estimated:
%         * For RBSs present in Lib24: inherited from Lib24 L1O reduced results.
%         * For RBS B0034 (RBS=3): inherited from Lib6 L1O reduced results.
%     - Effective gene copy number (Gene_cn) is inherited from Lib6 (L1O reduced),
%       and a fixed inv_sigma0 is used (set inside the script).
%
% DESCRIPTION
%   Loads the per-fold optimization outputs produced by
%   Estimate_Lib5_L1O_reduced_model (one file per left-out RBS/TU) and compiles
%   them into a unified Results tensor for Lib5.
%
%   For each L1O fold (i.e., each left-out RBS-defined TU), the script:
%     1) Loads the estimated Omega samples for that fold.
%     2) Stores fold-specific ("local") statistics in:
%          Parameters_local_raw / mean / std
%        which correspond to the Omega inferred when that TU is left out.
%
%   In addition, the script concatenates all Omega samples across folds to compute
%   global Lib5-level ("ALL") statistics:
%       Omega_raw / mean / std
%
%   The output tensor also includes:
%     - inherited parameter statistics (Gene_cn and RBS k0_sigma0),
%     - experimental Mu(t) and Pi(t) trajectories (Global / Instances / Wells),
%     - digital-twin predictions over experimental Mu(t),
%     - relative sensitivities mapped to absolute sensitivities,
%     - Monte Carlo propagated predictions over a Mu-grid, including kernel
%       density estimates and summary quantiles.
%
% INPUTS
%   None (loads results from ./Estimated_results/ and uses local configuration).
%
%   Configuration is set inside the script.
%   The user must set the desired <Use_mean> option. Options are:
%       - 'Global'    (global mean for each construct),
%       - 'Instances' (mean of each experiment for each construct),
%       - 'Wells'     (use data of all individual culture wells).
%
% OUTPUTS (saved to disk)
%   Results_Tensor_Lib5_L1O_reduced_model_<Use_mean>.mat
%     Example: Results_Tensor_Lib5_L1O_reduced_model_Wells.mat
%
%   The saved variable is:
%     Results_Tensor_Lib5_L1O_reduced
%
% DEPENDENCIES
%   - SynTwin initialization recommended:
%       ROOT = init_SynTwin(...);
%   - Requires the HEM surrogate:
%       Generate_HEM/HEM_Surrogate/HEM_Surrogate.mat
%   - Experimental data container for Lib5:
%       Experimental_Data/ExpData_Tensor_lib5_micro.mat
%   - Inherited parameter sources:
%       * Lib24 (L1O reduced) for RBSs except B0034:
%           L24_L1O_reduced_model/Results_Tensor_Lib24_L1O_reduced_*.mat
%       * Lib6 (L1O reduced) for B0034 and Gene_cn:
%           L6_L1O_reduced_model/Results_Tensor_Lib6_L1O_reduced_*.mat
%   - Requires per-fold estimation outputs generated by:
%       Estimate_Lib5_L1O_reduced_model
%     Expected naming pattern (one file per left-out RBS/TU):
%       ./Estimated_results/Results_BADS_Lib5_L1O_reduced_<Ori><Prom><RBS>_<Use_mean>.mat
%     (In Lib5, Ori and Prom are fixed; the fold is defined by the left-out RBS index.)
%
% USAGE
%   Generate_Results_Lib5_L1O_reduced_model
%
% NOTES
%   - Use_mean controls the aggregation level: 'Global', 'Instances', or 'Wells'.
%   - The output file is typically loaded by Show_Results_* scripts.
%   - L1O "local" parameter statistics are stored per TU (fold) via
%     Parameters_local_* fields; global Omega statistics are also reported by
%     pooling all folds (Omega_*).
%   - Monte Carlo predictions propagate uncertainty from inherited parameters
%     (Gene_cn and RBS k0_sigma0) and from the inferred promoter parameter Omega.

% --- Portable project initialization (no absolute paths) ---
ROOT = init_SynTwin('experimental',true);
% Ensure this script folder is on the path (for local functions in this folder)
SCRIPT_DIR = fileparts(mfilename('fullpath'));
addpath(SCRIPT_DIR);

% --- Load data using portable absolute paths ---
load(SynTwin_path('Generate_HEM','HEM_Surrogate','HEM_Surrogate.mat'));          % loads data of the Host Equivalent Model (HEM) 
load(SynTwin_path('Experimental_Data','ExpData_Tensor_lib5_micro.mat'));        % loads data of Lib5: ExpData_Tensor_lib5_micro

% Getting the data of Lib24 L1O reduced model (we ONLY use the estimated parameters for ori pGreen and RBSs from this file): 
load(SynTwin_path('Estimation_Pi/L24_L1O_reduced_model','Results_Tensor_Lib24_L1O_reduced_Wells.mat'));   

% Getting the estimated IIC (K/sigma) of RBS B0034 from Lib6: 
load(SynTwin_path('Estimation_Pi/L6_L1O_reduced_model','Results_Tensor_Lib6_L1O_reduced_Wells.mat'));   

% Consider an exogenous circuit. We use a Transcriptional Unit (TU) expressing GFP:
model_c.lp_c = 240; %Length of GFP protein (aa)     
model_c.le_c = model_c.lp_c^0.097/0.0703; 	%Ribosome occupancy length (aa) %lea=la^0.097/0.0703
model_c.dm_c  =  0.2; %Mean degradation rate of non-ribosomal mRNA (1/min)
model_c.Em_c =  model_c.lp_c/model_c.le_c*(1- (model_c.lp_c/(model_c.lp_c+model_c.le_c))^(model_c.lp_c/model_c.le_c)) ;  
model_c.WEm_c =  1 + 1/model_c.Em_c;  
model_c.N_pSC101 = 5; %known

% Options are: 
% - 'Global' (global mean for each construct),
% - 'Instances' (mean of each experiment for each construct),
% - 'Wells' (use data of all individual culture wells)

%Use_mean = 'Instances';  
%Use_mean = 'Global';  
Use_mean = 'Wells'; 

RBS_inv_sigma0 = 0.02;

% Getting the inherited estimated parameters
Inherited_ParamsData={};
indices_rbss_Lib24_dummy = [1,2,NaN,3,4];
Inherited_ParamsData.Gene_cn_MC_samples = Results_Tensor_Lib6_L1O_reduced{1,1}.Gene_cn_MC_samples;
for i=1:5
    if i==3
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_MC_samples = Results_Tensor_Lib6_L1O_reduced{1,1}.RBS_k0_sigma0_MC_samples;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_raw = Results_Tensor_Lib6_L1O_reduced{1,1}.RBS_k0_sigma0_raw;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_mean =  Results_Tensor_Lib6_L1O_reduced{1,1}.RBS_k0_sigma0_mean;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_std =   Results_Tensor_Lib6_L1O_reduced{1,1}.RBS_k0_sigma0_std;
    else
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_MC_samples = Results_Tensor_Lib24_L1O_reduced{1,1,indices_rbss_Lib24_dummy(i)}.RBS_k0_sigma0_MC_samples;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_raw = Results_Tensor_Lib24_L1O_reduced{1,1,indices_rbss_Lib24_dummy(i)}.RBS_k0_sigma0_raw;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_mean =  Results_Tensor_Lib24_L1O_reduced{1,1,indices_rbss_Lib24_dummy(i)}.RBS_k0_sigma0_mean;
        Inherited_ParamsData.RBS{i}.RBS_k0_sigma0_std =   Results_Tensor_Lib24_L1O_reduced{1,1,indices_rbss_Lib24_dummy(i)}.RBS_k0_sigma0_std;
    end
end

% Getting the estimated Omega for J23100
indices_plasmids_lib5 = 1;
num_plasmids_Lib5 = length(indices_plasmids_lib5);
indices_promoters_lib5 = 4;
num_promoters_Lib5 = length(indices_promoters_lib5);
indices_rbss_lib5 = [1,2,3,4,5];
num_rbss_Lib5 = length(indices_rbss_lib5);


% Loads the estimated parameters and generates the structure Estimated_parameters
Estimated_parameters_J23100.TU = {};
Matrix_tempo_All =[];
for p=1:length(indices_plasmids_lib5)
    for q=1:length(indices_promoters_lib5)
        for r=1:length(indices_rbss_lib5)
            Construct_2_LO = [indices_plasmids_lib5(p),indices_promoters_lib5(q),indices_rbss_lib5(r)];
            % --- Load estimation results from the local Estimated_results folder (portable) ---
            results_dir = fullfile(SCRIPT_DIR,'Estimated_results');
            if ~exist(results_dir,'dir')
                 error('Estimated_results folder not found: %s', results_dir);
            end
            file_name = "Results_BADS_Lib5_L1O_reduced_" + ...
                            num2str(indices_plasmids_lib5(p)) + ...
                            num2str(indices_promoters_lib5(q)) + ...
                            num2str(indices_rbss_lib5(r)) + "_" + ...
                            Use_mean + ".mat";
            file_tensor = fullfile(results_dir, file_name);
            load(file_tensor, "Results_BADS_J23100_L1O_approx", "-mat");
            num_runs = length(Results_BADS_J23100_L1O_approx);
            tempo = [];
            for i=1:num_runs
               tempo=[tempo;Results_BADS_J23100_L1O_approx{i}.results(:,1)];
               Matrix_tempo_All=[Matrix_tempo_All;Results_BADS_J23100_L1O_approx{i}.results(:,1)];
            end
            Estimated_parameters_J23100.TU{p,q,r}.raw = tempo;
            Estimated_parameters_J23100.TU{p,q,r}.mean = mean(tempo,1);
            Estimated_parameters_J23100.TU{p,q,r}.std = std(tempo, 0, 1);
        end %rbss
    end %promoters
end %plasmids
Estimated_parameters_J23100.ALL_raw = Matrix_tempo_All;
Estimated_parameters_J23100.ALL_mean = mean(Matrix_tempo_All,1);
Estimated_parameters_J23100.ALL_std = std(Matrix_tempo_All,0,1);

A=-1;
B=-1e-6;
n_samples_MC = 1000;
Estimated_parameters_J23100.Omega_MC_samples = rmvnrnd(Estimated_parameters_J23100.ALL_mean, Estimated_parameters_J23100.ALL_std.^2, n_samples_MC,A,B);


% Adds the estimated parameters, experimental and predicted synthesis and their statistics to the structure Results_Tensor_lib5_ALL_approx
for r=1:num_rbss_Lib5
    if strcmp(Use_mean,'Wells' )   
         Results_Tensor_Lib5_L1O_reduced{1,1,r}.Use_mean = 'Wells'; 
    elseif strcmp(Use_mean,'Instances')
         Results_Tensor_Lib5_L1O_reduced{1,1,r}.Use_mean = 'Instances'; 
    elseif strcmp(Use_mean,'Global')
         Results_Tensor_Lib5_L1O_reduced{1,1,r}.Use_mean ='Global'; 
    else
          error('Invalid option for Use_mean. Choose either "Wells", "Instances", or "Global".');
    end
    % General TU information:
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_Ori = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_Ori;
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_Promoter = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_Promoter;
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_RBS =  ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_RBS;
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_Bioparts  =  ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_Bioparts;
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_Name =  ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_Name;
  Results_Tensor_Lib5_L1O_reduced{1,1,r}.TU_color_code =  ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.TU_color_code;

   %Local estimations are the estimated parameters for all TUs but
    %in the (p,q,r)th-LOOCV iteration
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Parameters_local_raw = Estimated_parameters_J23100.TU{1,1,r}.raw;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Parameters_local_mean = Estimated_parameters_J23100.TU{1,1,r}.mean;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Parameters_local_std = Estimated_parameters_J23100.TU{1,1,r}.std;
    
   %Estimated parameters (Ori and RBSs inherited):
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_raw = Results_Tensor_Lib24_L1O_approx{1,1,1}.Gene_cn_raw;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_mean = Results_Tensor_Lib24_L1O_approx{1,1,1}.Gene_cn_mean;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_std =  Results_Tensor_Lib24_L1O_approx{1,1,1}.Gene_cn_std;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_raw = Estimated_parameters_J23100.ALL_raw; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_mean =  Estimated_parameters_J23100.ALL_mean; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_std =  Estimated_parameters_J23100.ALL_std; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_raw = Inherited_ParamsData.RBS{r}.RBS_k0_sigma0_raw; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_mean = Inherited_ParamsData.RBS{r}.RBS_k0_sigma0_mean; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_std = Inherited_ParamsData.RBS{r}.RBS_k0_sigma0_std; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_inv_sigma0_mean = RBS_inv_sigma0; 
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_inv_sigma0_std = 0; 

   % TU experimental data:
      % GLOBAL INFORMATION:
   Results_Tensor_Lib5_L1O_reduced{1,1,r}.Mu_mumax_pmax_global_mean = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Mu_mumax_pmax_global_mean;
   Results_Tensor_Lib5_L1O_reduced{1,1,r}.Mu_mumax_pmax_global_std = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Mu_mumax_pmax_global_std;
   Results_Tensor_Lib5_L1O_reduced{1,1,r}.Pi_mumax_pmax_global_mean = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Pi_mumax_pmax_global_mean;
   Results_Tensor_Lib5_L1O_reduced{1,1,r}.Pi_mumax_pmax_global_std = ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Pi_mumax_pmax_global_std;

    % INSTANCES INFORMATION:
   % go through all the instances:
   instance_count = length(ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances);
   Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances = cell(instance_count, 1);
   for w = 1:instance_count
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Mu_mumax_pmax_instance_mean = ...
            ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Mu_mumax_pmax_instance_mean;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Mu_mumax_pmax_instance_std = ...
            ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Mu_mumax_pmax_instance_std;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Pi_mumax_pmax_instance_mean = ...
            ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Pi_mumax_pmax_instance_mean;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Pi_mumax_pmax_instance_std = ...
            ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Pi_mumax_pmax_instance_std;
   end % for each instance

   % INDIVIDUAL WELLS INFORMATION:
   % go through all the instances and then all the wells for each instance:
  for w = 1:instance_count
      no_wells = length(ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Wells);
      Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Wells = cell(no_wells, 1);
      for ww = 1:no_wells
          Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Wells{ww}.Mu_mumax_pmax = ...
              ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Wells{ww}.Mu_mumax_pmax;
          Results_Tensor_Lib5_L1O_reduced{1,1,r}.Instances{w}.Wells{ww}.Pi_mumax_pmax = ...
              ExpData_Tensor_lib5_micro{1,1,indices_rbss_lib5(r)}.Instances{w}.Wells{ww}.Pi_mumax_pmax;
      end % for each well
  end % for each instance

 %Get the sensitivities of the synthesis rate w.r.t. the estimated parameters at the experimental values of growth rate:
      % GLOBAL 
      p=1;
      q=1;
      Mu_vector = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Mu_mumax_pmax_global_mean;
      Synthesis_predictions = Get_synthesis_predictions(HEM,model_c,Mu_vector,Results_Tensor_Lib5_L1O_reduced{p,q,r}.RBS_k0_sigma0_mean,...
                                   RBS_inv_sigma0,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Omega_mean,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Gene_cn_mean);
      Results_Tensor_Lib5_L1O_reduced{p,q,r}.S_Pi_NA_global_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Pi_mumax_pmax_global_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_NA_values;
      Results_Tensor_Lib5_L1O_reduced{p,q,r}.S_Pi_Omega_global_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Pi_mumax_pmax_global_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_Omega_values;
      Results_Tensor_Lib5_L1O_reduced{p,q,r}.S_Pi_RBS_k0_sigma0_global_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Pi_mumax_pmax_global_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_k0_sigma0_values;
      Results_Tensor_Lib5_L1O_reduced{p,q,r}.S_Pi_RBS_inv_sigma0_global_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Pi_mumax_pmax_global_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_inv_sigma0_values;
     % INSTANCES
     instance_count = length(Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances);
     for i = 1:instance_count
       if ~(isempty(Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Mu_mumax_pmax_instance_mean)) %some experiments can be empty if all wells of a construct are outliers
         Mu_vector = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Mu_mumax_pmax_instance_mean;
         Synthesis_predictions = Get_synthesis_predictions(HEM,model_c,Mu_vector,Results_Tensor_Lib5_L1O_reduced{p,q,r}.RBS_k0_sigma0_mean,...
                                   RBS_inv_sigma0,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Omega_mean,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Gene_cn_mean);
         Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.S_Pi_NA_instance_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Pi_mumax_pmax_instance_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_NA_values;
         Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.S_Pi_Omega_instance_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Pi_mumax_pmax_instance_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_Omega_values;
         Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.S_Pi_RBS_k0_sigma0_instance_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Pi_mumax_pmax_instance_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_k0_sigma0_values;
         Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.S_Pi_RBS_inv_sigma0_instance_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Pi_mumax_pmax_instance_mean.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_inv_sigma0_values;
       end % if not empty
    end % for each instance
    % WELLS
    for i = 1:instance_count
       if ~(isempty(Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Mu_mumax_pmax_instance_mean)) %some experiments can be empty if all wells of a construct are outliers
          no_wells = length(Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells);
          for j = 1:no_wells
              Mu_vector = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.Mu_mumax_pmax;
              Synthesis_predictions = Get_synthesis_predictions(HEM,model_c,Mu_vector,Results_Tensor_Lib5_L1O_reduced{p,q,r}.RBS_k0_sigma0_mean,...
                                   RBS_inv_sigma0,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Omega_mean,Results_Tensor_Lib5_L1O_reduced{p,q,r}.Gene_cn_mean);
              Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.S_Pi_NA_well_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.Pi_mumax_pmax.*Synthesis_predictions.Relative_sensitivities.S_Pi_NA_values;
              Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.S_Pi_Omega_well_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.Pi_mumax_pmax.*Synthesis_predictions.Relative_sensitivities.S_Pi_Omega_values;
              Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.S_Pi_RBS_k0_sigma0_well_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.Pi_mumax_pmax.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_k0_sigma0_values; 
              Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.S_Pi_RBS_inv_sigma0_well_values = Results_Tensor_Lib5_L1O_reduced{p,q,r}.Instances{i}.Wells{j}.Pi_mumax_pmax.*Synthesis_predictions.Relative_sensitivities.S_Pi_RBS_inv_sigma0_values;
          end % for each well
       end % if not empty
   end % for each instance


     % Get synthesis predictions for a range of values of growth rate:
     Mu_vector =  0.005:0.003:0.032;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Synthesis_predictions = Get_synthesis_predictions(HEM,model_c,Mu_vector,Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_mean,...
                                                   Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_inv_sigma0_mean,Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_mean,Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_mean);
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Mu_slices_values = Mu_vector;
    
    % MONTE CARLO predictions for a range of values of growth rate:
    % First generate distributions for the parameters
    % To avoid values less or equal to zero, uses Tim Benham (2025). Truncated multivariate normal (https://www.mathworks.com/matlabcentral/fileexchange/34402-truncated-multivariate-normal), MATLAB Central File Exchange.
     A=-1;
     B=-1e-6;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_MC_samples = Inherited_ParamsData.Gene_cn_MC_samples;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_MC_samples = Estimated_parameters_J23100.Omega_MC_samples;
     Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_MC_samples = Inherited_ParamsData.RBS{r}.RBS_k0_sigma0_MC_samples;
     MC_indexes = 1:1:n_samples_MC; 
     for j=1:n_samples_MC
         sample_gen_cn = Results_Tensor_Lib5_L1O_reduced{1,1,r}.Gene_cn_MC_samples(MC_indexes(j));
         sample_Omega = Results_Tensor_Lib5_L1O_reduced{1,1,r}.Omega_MC_samples(MC_indexes(j));
         sample_RBS_k0_sigma0 = Results_Tensor_Lib5_L1O_reduced{1,1,r}.RBS_k0_sigma0_MC_samples(MC_indexes(j));
         RBS_inv_sigma0 = 0.02;
         Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_samples(j).Synthesis_predictions = Get_synthesis_predictions(HEM,model_c,Mu_vector,...
                                                      sample_RBS_k0_sigma0,RBS_inv_sigma0,sample_Omega,sample_gen_cn);
     end % for MC samples

    % Next, for each value of growth rate, we can get the probability density function of the predicted synthesis rate and get statistics from it
   MC_Pi_pred_mu = NaN*ones(n_samples_MC,length(Mu_vector)); %each column is a value of growth rate, each row is a MC sample
   MC_Pi_pred_mu_approx = NaN*ones(n_samples_MC,length(Mu_vector)); 
   for j=1:n_samples_MC
       MC_Pi_pred_mu(j,:) = Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_samples(j).Synthesis_predictions.Pi_pred_values';
   end
 
   for m=1:length(Mu_vector)
    pd = fitdist(MC_Pi_pred_mu(:,m),'kernel','Kernel','epanechnikov');
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pdf = pd;
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Mu_slice = Mu_vector(m);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_mean = mean(pd);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_std = std(pd);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_q50 = icdf(pd,0.5);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_q25 = icdf(pd,0.25);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_q75 = icdf(pd,0.75);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_q2p5 = icdf(pd,0.025);
    Results_Tensor_Lib5_L1O_reduced{1,1,r}.MC_mu_slices(m).Pi_pred_q97p5 = icdf(pd,0.975);
   end

end %rbss

% SAVE the results
% --- Save generated results in the same folder as this script (portable) ---
file_name  = "Results_Tensor_Lib5_L1O_reduced_" + Use_mean + ".mat";
file_tensor = fullfile(SCRIPT_DIR, file_name);
save(file_tensor, "Results_Tensor_Lib5_L1O_reduced", "-mat");