function Plot_Results_Lib5_reduced_model(Results_Lib,Lower_Bounds,Upper_Bounds,indices_plasmids,indices_promoters,indices_rbss, title_text)
% The function takes the complete results of the estimation of a library,
% as stord in the files generated by Make_Results_LibX_LOOCV_CSIC.m and
% Make_Results_LibX_FULL_CSIC.m with X=24,30, and plots the main features.
%
% Notice if you just wnat to plot experimental results, you can use Plot_ExpData_Tensor_v1.m

color_blue = hex2rgb('#00008B');
color_grey = hex2rgb('#4b4b4b');
color_grey_boira = hex2rgb('#F2F2F2');
color_grey_neutre = hex2rgb('#CCCCCC');
RBS_colors= ['#A8DADC';'#F4A261';'#B5E48C';'#CDB4DB';'#FFE066'];
Promoter_colors = ['#264653';'#E76F51';'#2A9D8F';'#6A0572'];

num_plasmids = length(indices_plasmids);
num_promoters=length(indices_promoters);
num_rbss = length(indices_rbss);

x_L = Lower_Bounds;
x_U = Upper_Bounds;

%% ESTIMATED PARAMETERS HISTOGRAMS

% HISTOGRAMS OF Omega
figure();
tiledlayout(1,1);
nexttile;
Data_Omega_mean = Results_Lib{1,1,1}.Omega_mean;
Data_Omega_raw = Results_Lib{1,1,1}.Omega_raw;
pd1 = histfit(Data_Omega_raw,[],'normal');%nbins set to default round(sqrt(num_data))
grid on;
pd1(1).FaceColor = Promoter_colors(indices_promoters,:);
pd1(2).Color = Promoter_colors(indices_promoters,:);
pd1(1).FaceAlpha = 1;
hold on
xline( Data_Omega_mean,'Color','k','LineWidth',1 ); 
xlabel('$\omega\, (\mathrm{molec}\cdot\mathrm{min}^{-1})$','FontSize',18,'Interpreter','latex')
t= title([title_text, Results_Lib{1,1,1}.TU_Promoter]);
 t.FontSize = 18;
ax=gca;
ax.XAxis.FontSize = 18;
ax.YAxis.FontSize = 18;
ax.XLabel.FontSize = 18;
ax.YLabel.FontSize = 18;



% END OF HISTOGRAMS OF ESTIMATED PARAMETERS

%% PREDICTED SYNTHESIS RATES VERSUS EXPERIMENTAL ONES

% TILED PLOT OF PI_PRED, PI_EXP VERSUS MU (95% CONFIDENCE INTERVAL)

figure();
tiledlayout(1,num_rbss);
for k=1:num_rbss  %RBS
  if not(isempty(Results_Lib{1,1,k}))
    tile_num = k; 
    nexttile(tile_num)
    hold on
    Bioparts_TU= Results_Lib{1,1,k}.TU_Bioparts;
    Color_TU= Results_Lib{1,1,k}.TU_color_code;
    num_slices = length(Results_Lib{1,1,k}.MC_mu_slices);
    for q=1:num_slices
      xmu(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Mu_slice;
      yl(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q2p5;
      yu(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q97p5;
      ymean(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q50;
    end
    plot(xmu,ymean,'linestyle','-','Color',color_blue,'LineWidth',2,'HandleVisibility','off')
    plot(xmu,yl,'linestyle','-','Color',color_blue,'LineWidth',1,'HandleVisibility','off')
    plot(xmu, yu,'linestyle','-','Color',color_blue,'LineWidth',1,'HandleVisibility','off')
    p = fill([xmu,xmu(end:-1:1)],[yl,yu(end:-1:1)],Color_TU,'FaceAlpha',0.2);
    % Full set of experimental data 
    num_instances = length(Results_Lib{1,1,k}.Instances);
    for q=1:num_instances
      % For the average of the wells in each instance of each experiment use this below
       y = Results_Lib{1,1,k}.Instances{q}.Mu_mumax_pmax_instance_mean;
       x = Results_Lib{1,1,k}.Instances{q}.Pi_mumax_pmax_instance_mean;
       s= plot(x,y,'Color',color_grey_neutre,'LineStyle','-','LineWidth',0.5,'HandleVisibility','off');
    end %instances
    grid on
    ax=gca;
    ax.XLim=[xmu(1),xmu(end)];
    ax.XAxis.FontSize = 18;
    ax.YAxis.FontSize = 18;
    ax.XLabel.FontSize = 18;
    ax.YLabel.FontSize = 18;
    if  k==1
       t= title([title_text, Bioparts_TU]);
    else
       t= title(Bioparts_TU);
    end
    t.FontSize = 18;
    xlabel('$\mu$','FontSize',18,'Interpreter','latex')
    ylabel('$\Pi_p$','FontSize',18,'Interpreter','latex')
  end %not empty TU
end


% TILED PLOT OF PI_PRED, PI_EXP VERSUS MU (95% CONFIDENCE INTERVAL IN BOTH)
figure();
tiledlayout(1,num_rbss);
for k=1:num_rbss  %RBS
  if not(isempty(Results_Lib{1,1,k}))
    tile_num = k; 
    nexttile(tile_num)
    hold on
    Bioparts_TU= Results_Lib{1,1,k}.TU_Bioparts;
    Color_TU= Results_Lib{1,1,k}.TU_color_code;
    num_slices = length(Results_Lib{1,1,k}.MC_mu_slices);
    for q=1:num_slices
      xmu(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Mu_slice;
      yl(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q2p5;
      yu(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q97p5;
      ymean(q) = Results_Lib{1,1,k}.MC_mu_slices(q).Pi_pred_q50;
    end
    plot(xmu,ymean,'linestyle','-','Color',Color_TU,'LineWidth',2,'HandleVisibility','off')
    plot(xmu,yl,'linestyle','-','Color',Color_TU,'LineWidth',1,'HandleVisibility','off')
    plot(xmu, yu,'linestyle','-','Color',Color_TU,'LineWidth',1,'HandleVisibility','off')
    p = fill([xmu,xmu(end:-1:1)],[yl,yu(end:-1:1)],Color_TU,'FaceAlpha',0.99);

     y_g = Results_Lib{1,1,k}.Pi_mumax_pmax_global_mean;
     x_g = Results_Lib{1,1,k}.Mu_mumax_pmax_global_mean;
     y_g_std = Results_Lib{1,1,k}.Pi_mumax_pmax_global_std;
     x_gn = x_g(end:-1:1);
     y_gn = y_g(end:-1:1);
     y_gn_std = y_g_std(end:-1:1);
     yln = y_gn - 2*y_gn_std;
     yun = y_gn + 2*y_gn_std;
     plot(x_gn,yln,'linestyle','-','Color',color_grey,'LineWidth',0.5,'HandleVisibility','off')
     plot(x_gn, yun,'linestyle','-','Color',color_grey,'LineWidth',0.5,'HandleVisibility','off')
     p = fill([x_gn;x_gn(end:-1:1)],[yln;yun(end:-1:1)],color_grey,'FaceAlpha',0.25);
     plot(x_g,y_g,'Color',color_grey_neutre,'LineWidth',2,'HandleVisibility','on')
     grid on
    
     if k==1
       t= title([title_text, Bioparts_TU]);
       ylabel('$\Pi_p$','FontSize',18,'Interpreter','latex')
     else
       t= title(Bioparts_TU);
     end
     t.FontSize = 18;
     xlabel('$\mu$','FontSize',18,'Interpreter','latex')
     ax=gca;
     ax.XLim=[x_gn(1),x_gn(end)];
     ax.YLim=[min(0.8*yln(1),yl(1)),1.2*yun(end)];
    ax.XAxis.FontSize = 18;
    ax.YAxis.FontSize = 18;
    ax.XLabel.FontSize = 18;
    ax.YLabel.FontSize = 18;
  end %not empty
end %rbs
  
